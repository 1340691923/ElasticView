import{bf as e,d as l,aT as a,c as t,aU as o,r as s,a0 as i,cs as r,J as d,o as n,ct as c,aM as p,e as u,h as f,C as m,g as h,l as g,w as y,a9 as _,i as b,p as k,a7 as v,F as w,a3 as C,f as x,S as j,j as V,aZ as $,a2 as A,b8 as T,a_ as S,E,a5 as N,a6 as U,bi as O,b1 as z,b2 as M}from"./index.CLV6ek40.js";import{E as R}from"./el-loading.BUdDMhkI.js";import{E as L,a as J}from"./el-tab-pane.Bx882FCs.js";import{E as P}from"./el-tree.Bk3X54JO.js";import"./el-checkbox.CjSQ3F-Y.js";import{E as B}from"./el-pagination.D7JQcvSn.js";/* empty css               */import"./el-select.Cgog8UO3.js";import"./el-scrollbar.JSBZHDlB.js";import"./el-popper.DN1O68l_.js";import{E as I}from"./el-card.BDOdcgEj.js";import{E as D,a as F}from"./el-table-column.BPgiV38a.js";import{a as K,b as q,E as G}from"./el-dropdown-item.BLS-zIe0.js";import{a as H,E as Q}from"./el-form.D6tidVci.js";import"./el-form-item.l0sNRNKZ.js";import{d as Z}from"./index.B6fdKp2E.js";import{U as W}from"./api-rbac.BUI268oD.js";import{_ as X}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./use-dialog.B7hCziNn.js";import"./isUndefined.DgmxjSXK.js";import"./strings.CS2wJJ2k.js";import"./index.DHrNonpr.js";import"./index.DXxCJmyx.js";import"./_Uint8Array.DIi5Oa4y.js";import"./dropdown.OSpZgcEC.js";import"./refs.QvgRPoko.js";const Y={class:"app-container"},ee=(e=>(z("data-v-13c56fef"),e=e(),M(),e))((()=>m("span",null,"搜索条件",-1))),le={class:"pagination-container"},ae={class:"permission-header"},te={class:"permission-header"},oe={class:"drawer-footer"},se=X(l({__name:"role",setup(l){const z=a(),M=t((()=>z.device===o.MOBILE)),X=s(0),se=e=>{Ce.limit=e,xe(1)},ie={id:"",name:"",description:"",routes:[],api:[]},re=i({role_name:""}),de=i({asyncRoutes:r,allAsyncRoutes:[],editLinkRoleId:0,loading:!1,allApiConfig:[],value:[],filterMethod:(e,l)=>l.label.indexOf(e)>-1,urlConfig:[],urlConfigMap:[],filterText:"",filterText4Api:"",role:Object.assign({},ie),routes:[],rolesList:[],dialogVisible:!1,esLinkDialogVisible:!1,dialogType:"new",checkStrictly:!1,defaultProps:{children:"children",label:"title"},defaultProps4Api:{children:"options",label:"label"},chanCfgList:[],apiCfg:[],selectAllApiCfg:[],apiMap:{},data:[]}),ne=s(),ce=s();d(de.filterText,(e=>{ne.value.filter(e)})),d(de.filterText4Api,(e=>{ce.value.filter(e)})),n((async()=>{await pe(),me(),xe(1)}));const pe=async()=>{let e=await W({need_auth:!0});if(0==e.code){let l=JSON.parse(JSON.stringify(e.data.cfg_with_module)),a=l.length;for(;a--;){let e=l[a],t=e.options.length,o=e.options;for(;t--;)o[t].needAuth||o.splice(t,1),0==o.length&&l.splice(a,1)}de.apiMap={},de.selectAllApiCfg=[];for(let e of l)for(let l of e.options)de.selectAllApiCfg.push(l),de.apiMap[l.value]=l;de.apiCfg=l}},ue=()=>{ne.value.setCheckedNodes(de.routes)},fe=()=>{ce.value.setCheckedNodes(de.selectAllApiCfg)},me=async()=>{let e=await c({routers:r});de.allAsyncRoutes=e.data;var l=e.data;de.routes=ge(l)},he=(e=[],l)=>{let a=null;const t=e.filter((e=>!e.hidden));return 1===t.length?(a=t[0],a.path=p.resolve(l.path,a.path),a):0===t.length&&(a={...l,path:"",noShowingChildren:!0},a)},ge=(e,l="/")=>{const a=[];for(let t of e){if(t.hidden&&!t.service)continue;const e=he(t.children,t);t.children&&t.children.length>0&&e&&!t.alwaysShow&&(t=e);const o={path:p.resolve(l,t.path),title:t.meta&&t.meta.title};t.children&&t.children.length>0&&(o.children=ge(t.children,o.path)),a.push(o)}return a},ye=e=>{let l=[];return e.forEach((e=>{if(l.push(e),e.children&&e.children.length>0){const a=ye(e.children);a.length>0&&(l=[...l,...a])}})),l},_e=(e,l="/",a)=>{const t=[];for(const o of e)o.children&&o.children.length>0&&(o.children=_e(o.children,p.resolve(l,o.path),a)),(a.includes(p.resolve(l,o.path))||o.children&&o.children.length>=1)&&t.push(o);return t},be=(e,l)=>!e||-1!==l.title.indexOf(e),ke=(e,l)=>!e||-1!==l.label.indexOf(e),ve=()=>{de.role=Object.assign({},ie),ne.value&&ne.value.setCheckedNodes([]),ce.value&&ce.value.setCheckedNodes([]),de.dialogType="new",de.dialogVisible=!0},we=e=>{de.dialogType="edit",de.dialogVisible=!0,de.checkStrictly=!0,de.role=Z(e),A((()=>{const e=ge(de.role.routes);ne.value.setCheckedNodes(ye(e));let l=[];for(let a of de.role.api)l.push(de.apiMap[a]);ce.value&&ce.value.setCheckedNodes(l),de.checkStrictly=!1}))},Ce=i({page:1,limit:10}),xe=async l=>{Ce.page=l||1,de.loading=!0;const a=await(t={role_name:re.role_name,page:l,page_size:Ce.limit},e({url:"/api/gm_user/roles",method:"post",data:t}));var t;for(var o in de.loading=!1,a.data.list)a.data.list[o].routes=JSON.parse(a.data.list[o].routes);X.value=a.data.count,de.rolesList=a.data.list},je=({$index:l,row:a})=>{T.confirm("确定删除这个权限组吗?","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((async()=>{let l=await(t={id:a.id},e({url:"/api/gm_user/role/delete",method:"post",data:t}));var t;0==l.code?(await xe(1),0==l.code?S.success({type:"success",offset:60,message:l.msg}):S.error({type:"error",offset:60,message:l.msg})):S.error({type:"error",offset:60,message:l.msg})})).catch((e=>{console.error(e)}))},Ve=async()=>{if(ce.value){const e=ce.value.getCheckedNodes(!0,!1);let l=[];for(let a of e)l.push(a.value);de.role.api=l}const l="edit"===de.dialogType,a=ne.value.getCheckedKeys();de.role.routes=_e(Z(de.allAsyncRoutes),"/",a);var t=de.role;if(""!=t.name.trim()){if(t.routes=JSON.stringify(t.routes),l){t.id=de.role.id;let l=await(o=t,e({url:"/api/gm_user/role/update",method:"post",data:o}));if(0!=l.code)return void S.error({type:"error",offset:60,message:l.msg});xe(1)}else{t.id=0;const l=await function(l){return e({url:"/api/gm_user/role/add",method:"post",data:l})}(t);if(0!=l.code)return void S.error({type:"error",offset:60,message:l.msg});xe(1)}var o;de.dialogVisible=!1,S.success({type:"success",offset:60,message:"操作成功"})}else S.error({type:"error",offset:60,message:"权限组名称不能为空"})},$e=s("basic"),Ae=s(!0),Te=()=>{Ae.value=!Ae.value};return(e,l)=>{const a=E,t=N,o=H,s=U,i=Q,r=D,d=K,n=q,c=G,p=F,A=I,T=B,S=L,z=P,Z=J,W=R,ie=O;return u(),f("div",Y,[m("div",{class:b(["search-container",{"is-collapsed":h(Ae)&&h(M)}])},[h(M)?(u(),f("div",{key:0,class:"search-header",onClick:Te},[ee,g(a,{class:b({"is-collapsed":h(Ae)})},{default:y((()=>[g(h(_))])),_:1},8,["class"])])):k("",!0),g(i,{inline:!0},{default:y((()=>[g(o,{label:"权限组名称:",prop:"keywords"},{default:y((()=>[g(t,{clearable:"",modelValue:h(re).role_name,"onUpdate:modelValue":l[0]||(l[0]=e=>h(re).role_name=e),style:{width:"160px"}},null,8,["modelValue"])])),_:1}),g(o,{class:"button-group"},{default:y((()=>[g(s,{type:"success",class:"filter-item",onClick:l[1]||(l[1]=e=>xe(1))},{default:y((()=>[v(w(e.$t("搜索")),1)])),_:1}),g(s,{type:"warning",class:"filter-item",onClick:ve},{default:y((()=>[v(w(e.$t("新增")),1)])),_:1})])),_:1})])),_:1})],2),g(A,{shadow:"never",class:"table-container"},{default:y((()=>[C((u(),x(p,{data:h(de).rolesList,onRowDblclick:we},{default:y((()=>[g(r,{prop:"id",align:"center",label:e.$t("id"),width:"36"},{default:y((e=>[v(w(e.row.id),1)])),_:1},8,["label"]),g(r,{prop:"name",align:"center",label:e.$t("权限组名称"),width:"200"},{default:y((e=>[v(w(e.row.name),1)])),_:1},8,["label"]),g(r,{prop:"description",align:"header-center",label:e.$t("备注")},{default:y((e=>[v(w(e.row.description),1)])),_:1},8,["label"]),g(r,{align:"center",label:e.$t("操作"),width:h(M)?120:200,fixed:"right"},{default:y((e=>[h(M)?(u(),x(c,{key:1,trigger:"click",onCommand:l=>((e,l)=>{"edit"===l?we(e.row):"delete"===l&&je(e)})(e,l)},{dropdown:y((()=>[g(n,null,{default:y((()=>[g(d,{command:"edit"},{default:y((()=>[g(s,{type:"primary"},{default:y((()=>[v("编辑")])),_:1})])),_:1}),g(d,{command:"delete",divided:""},{default:y((()=>[g(s,{type:"danger"},{default:y((()=>[v("删除")])),_:1})])),_:1})])),_:1})])),default:y((()=>[g(s,null,{default:y((()=>[v(" 管理 ")])),_:1})])),_:2},1032,["onCommand"])):(u(),f(j,{key:0},[g(s,{type:"primary",onClick:V((l=>we(e.row)),["stop"])},{default:y((()=>[v(" 编辑 ")])),_:2},1032,["onClick"]),g(s,{type:"danger",onClick:V((l=>je(e)),["stop"])},{default:y((()=>[v(" 删除 ")])),_:2},1032,["onClick"])],64))])),_:1},8,["label","width"])])),_:1},8,["data"])),[[ie,h(de).loading]])])),_:1}),m("div",le,[g(T,{background:"","current-page":h(Ce).page,"page-size":h(Ce).limit,total:h(X),layout:h(M)?"pager":"total, sizes, prev, pager, next, jumper",onCurrentChange:xe,onSizeChange:se},null,8,["current-page","page-size","total","layout"])]),g(W,{size:h(M)?"100%":"70%",modelValue:h(de).dialogVisible,"onUpdate:modelValue":l[8]||(l[8]=e=>h(de).dialogVisible=e),title:"edit"===h(de).dialogType?e.$t("修改权限组"):e.$t("新建权限组")},{footer:y((()=>[m("div",oe,[g(s,{type:"danger",onClick:l[7]||(l[7]=e=>h(de).dialogVisible=!1)},{default:y((()=>[v(w(e.$t("取消")),1)])),_:1}),g(s,{type:"primary",onClick:Ve},{default:y((()=>[v(w(e.$t("确定")),1)])),_:1})])])),default:y((()=>[g(Z,{modelValue:h($e),"onUpdate:modelValue":l[6]||(l[6]=e=>$($e)?$e.value=e:null)},{default:y((()=>[g(S,{label:e.$t("基本信息"),name:"basic"},{default:y((()=>[g(i,{model:h(de).role,"label-width":"80px","label-position":"left"},{default:y((()=>[g(o,{label:e.$t("权限组名称")},{default:y((()=>[g(t,{modelValue:h(de).role.name,"onUpdate:modelValue":l[2]||(l[2]=e=>h(de).role.name=e),placeholder:e.$t("权限组名称")},null,8,["modelValue","placeholder"])])),_:1},8,["label"]),g(o,{label:e.$t("备注")},{default:y((()=>[g(t,{modelValue:h(de).role.description,"onUpdate:modelValue":l[3]||(l[3]=e=>h(de).role.description=e),autosize:{minRows:2,maxRows:4},type:"textarea",placeholder:e.$t("备注")},null,8,["modelValue","placeholder"])])),_:1},8,["label"])])),_:1},8,["model"])])),_:1},8,["label"]),1!=h(de).role.id?(u(),x(S,{key:0,label:e.$t("菜单权限"),name:"menu"},{default:y((()=>[m("div",ae,[g(t,{modelValue:h(de).filterText,"onUpdate:modelValue":l[4]||(l[4]=e=>h(de).filterText=e),placeholder:e.$t("输入关键字进行过滤"),class:"filter-input"},null,8,["modelValue","placeholder"]),g(s,{onClick:ue},{default:y((()=>[v(w(e.$t("全选")),1)])),_:1})]),g(z,{"default-expand-all":"","check-on-click-node":"",ref_key:"menu_tree",ref:ne,"filter-node-method":be,"check-strictly":h(de).checkStrictly,data:h(de).routes,props:h(de).defaultProps,"show-checkbox":"","node-key":"path",class:"permission-tree"},null,8,["check-strictly","data","props"])])),_:1},8,["label"])):k("",!0),1!=h(de).role.id?(u(),x(S,{key:1,label:e.$t("接口权限"),name:"api"},{default:y((()=>[m("div",te,[g(t,{modelValue:h(de).filterText4Api,"onUpdate:modelValue":l[5]||(l[5]=e=>h(de).filterText4Api=e),placeholder:e.$t("输入关键字进行过滤"),class:"filter-input"},null,8,["modelValue","placeholder"]),g(s,{onClick:fe},{default:y((()=>[v(w(e.$t("全选")),1)])),_:1})]),g(z,{"default-expand-all":"","check-on-click-node":"",ref_key:"api_tree",ref:ce,"filter-node-method":ke,"check-strictly":h(de).checkStrictly,data:h(de).apiCfg,props:h(de).defaultProps4Api,"show-checkbox":"","node-key":"value",class:"permission-tree"},null,8,["check-strictly","data","props"])])),_:1},8,["label"])):k("",!0)])),_:1},8,["modelValue"])])),_:1},8,["size","modelValue","title"])])}}}),[["__scopeId","data-v-13c56fef"]]);export{se as default};
//# sourceMappingURL=role.dIZ4Q9Da.js.map
