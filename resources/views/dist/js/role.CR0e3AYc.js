import{b7 as e,d as l,aQ as t,c as a,aV as o,r as i,a0 as r,cb as s,J as d,o as n,cc as c,aJ as p,e as u,h,C as f,l as m,w as g,a7 as y,F as b,a3 as k,f as _,g as v,j as w,bI as C,bJ as x,p as j,a2 as V,aY as A,b5 as $,a6 as T,a5 as S,ba as N}from"./index.DXEnBsU-.js";/* empty css                   */import{E as O}from"./el-drawer.BCyMtrUV.js";import{E}from"./el-tree.CkFRcQgL.js";import"./el-checkbox.BSVWGSnx.js";import{E as R}from"./el-pagination.D6TNZcC6.js";/* empty css               */import"./el-select.D_RdXRk0.js";import"./el-scrollbar.v1J_9dPK.js";import"./el-tooltip.BJE2ZRH-.js";import{E as U}from"./el-card.BtZDn0uG.js";import{E as z,a as J}from"./el-table-column.C-GnYxI4.js";import{a as L,E as M}from"./el-form.DzZwTs12.js";import"./el-form-item.l0sNRNKZ.js";import{d as B}from"./index.B6fdKp2E.js";import{U as I}from"./api-rbac.5Hqo8e_q.js";import{_ as P}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./use-dialog.C23R4RJY.js";import"./isUndefined.DgmxjSXK.js";import"./index.6-cmkaky.js";import"./strings.BZrAlt1C.js";import"./index.Duti2LV-.js";import"./_Uint8Array.1eytTgEC.js";const D={class:"app-container"},F={class:"search-container"},q={class:"pagination-container"},G=P(l({__name:"role",setup(l){const P=t(),G=a((()=>P.device===o.MOBILE)),H=i(0),K=e=>{pe.limit=e,ue(1)},Q={id:"",name:"",description:"",routes:[],api:[]},Y=r({asyncRoutes:s,allAsyncRoutes:[],editLinkRoleId:0,loading:!1,allApiConfig:[],value:[],filterMethod:(e,l)=>l.label.indexOf(e)>-1,urlConfig:[],urlConfigMap:[],filterText:"",filterText4Api:"",role:Object.assign({},Q),routes:[],rolesList:[],dialogVisible:!1,esLinkDialogVisible:!1,dialogType:"new",checkStrictly:!1,defaultProps:{children:"children",label:"title"},defaultProps4Api:{children:"options",label:"label"},chanCfgList:[],apiCfg:[],selectAllApiCfg:[],apiMap:{},data:[]}),W=i(),X=i();d(Y.filterText,(e=>{W.value.filter(e)})),d(Y.filterText4Api,(e=>{X.value.filter(e)})),n((async()=>{await Z(),te(),ue(1)}));const Z=async()=>{let e=await I({need_auth:!0});if(0==e.code){let l=JSON.parse(JSON.stringify(e.data.cfg_with_module)),t=l.length;for(;t--;){let e=l[t],a=e.options.length,o=e.options;for(;a--;)o[a].needAuth||o.splice(a,1),0==o.length&&l.splice(t,1)}Y.apiMap={},Y.selectAllApiCfg=[];for(let e of l)for(let l of e.options)Y.selectAllApiCfg.push(l),Y.apiMap[l.value]=l;Y.apiCfg=l}},ee=()=>{W.value.setCheckedNodes(Y.routes)},le=()=>{X.value.setCheckedNodes(Y.selectAllApiCfg)},te=async()=>{let e=await c({routers:s});Y.allAsyncRoutes=e.data;var l=e.data;Y.routes=oe(l)},ae=(e=[],l)=>{let t=null;const a=e.filter((e=>!e.hidden));return 1===a.length?(t=a[0],t.path=p.resolve(l.path,t.path),t):0===a.length&&(t={...l,path:"",noShowingChildren:!0},t)},oe=(e,l="/")=>{const t=[];for(let a of e){if(a.hidden&&!a.service)continue;const e=ae(a.children,a);a.children&&a.children.length>0&&e&&!a.alwaysShow&&(a=e);const o={path:p.resolve(l,a.path),title:a.meta&&a.meta.title};a.children&&a.children.length>0&&(o.children=oe(a.children,o.path)),t.push(o)}return t},ie=e=>{let l=[];return e.forEach((e=>{if(l.push(e),e.children&&e.children.length>0){const t=ie(e.children);t.length>0&&(l=[...l,...t])}})),l},re=(e,l="/",t)=>{const a=[];for(const o of e)o.children&&o.children.length>0&&(o.children=re(o.children,p.resolve(l,o.path),t)),(t.includes(p.resolve(l,o.path))||o.children&&o.children.length>=1)&&a.push(o);return a},se=(e,l)=>!e||-1!==l.title.indexOf(e),de=(e,l)=>!e||-1!==l.label.indexOf(e),ne=()=>{Y.role=Object.assign({},Q),W.value&&W.value.setCheckedNodes([]),X.value&&X.value.setCheckedNodes([]),Y.dialogType="new",Y.dialogVisible=!0},ce=e=>{Y.dialogType="edit",Y.dialogVisible=!0,Y.checkStrictly=!0,Y.role=B(e),V((()=>{const e=oe(Y.role.routes);W.value.setCheckedNodes(ie(e));let l=[];for(let t of Y.role.api)l.push(Y.apiMap[t]);X.value&&X.value.setCheckedNodes(l),Y.checkStrictly=!1}))},pe=r({page:1,limit:10}),ue=async l=>{pe.page=l||1,Y.loading=!0;const t=await(a={page:l,page_size:pe.limit},e({url:"/api/gm_user/roles",method:"post",data:a}));var a;for(var o in Y.loading=!1,t.data.list)t.data.list[o].routes=JSON.parse(t.data.list[o].routes);H.value=t.data.count,Y.rolesList=t.data.list},he=({$index:l,row:t})=>{A.confirm("确定删除这个角色吗?","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((async()=>{let l=await(a={id:t.id},e({url:"/api/gm_user/role/delete",method:"post",data:a}));var a;0==l.code?(await ue(1),0==l.code?$.success({type:"success",message:l.msg}):$.error({type:"error",message:l.msg})):$.error({type:"error",message:l.msg})})).catch((e=>{console.error(e)}))},fe=async()=>{if(X.value){const e=X.value.getCheckedNodes(!0,!1);let l=[];for(let t of e)l.push(t.value);Y.role.api=l}const l="edit"===Y.dialogType,t=W.value.getCheckedKeys();Y.role.routes=re(B(Y.allAsyncRoutes),"/",t);var a,o=Y.role;if(o.routes=JSON.stringify(o.routes),l){o.id=Y.role.id;let l=await(a=o,e({url:"/api/gm_user/role/update",method:"post",data:a}));if(0!=l.code)return void $.error({type:"error",message:l.msg});ue(1)}else{o.id=0;const l=await function(l){return e({url:"/api/gm_user/role/add",method:"post",data:l})}(o);if(0!=l.code)return void $.error({type:"error",message:l.msg});ue(1)}Y.dialogVisible=!1,$.success({type:"success",message:"操作成功"})};return(e,l)=>{const t=T,a=L,o=M,i=z,r=J,s=U,d=R,n=S,c=E,p=O,V=N;return u(),h("div",D,[f("div",F,[m(o,{inline:!0},{default:g((()=>[m(a,{label:"",prop:"keywords"},{default:g((()=>[m(t,{type:"warning",class:"filter-item",onClick:ne},{default:g((()=>[y(b(e.$t("新增")),1)])),_:1}),m(t,{type:"success",class:"filter-item",onClick:l[0]||(l[0]=e=>ue(1))},{default:g((()=>[y(b(e.$t("搜索")),1)])),_:1})])),_:1})])),_:1})]),m(s,{shadow:"never",class:"table-container"},{default:g((()=>[k((u(),_(r,{data:v(Y).rolesList,onRowDblclick:ce},{default:g((()=>[m(i,{align:"center",label:e.$t("id"),width:"40"},{default:g((e=>[y(b(e.row.id),1)])),_:1},8,["label"]),m(i,{align:"center",label:e.$t("角色名"),width:"100"},{default:g((e=>[y(b(e.row.name),1)])),_:1},8,["label"]),m(i,{align:"header-center",label:e.$t("角色详细信息")},{default:g((e=>[y(b(e.row.description),1)])),_:1},8,["label"]),m(i,{align:"center",label:e.$t("操作"),width:"140",fixed:"right"},{default:g((e=>[m(t,{type:"primary",onClick:w((l=>ce(e.row)),["stop"]),icon:v(C)},null,8,["onClick","icon"]),m(t,{type:"danger",onClick:w((l=>he(e)),["stop"]),icon:v(x)},null,8,["onClick","icon"])])),_:1},8,["label"])])),_:1},8,["data"])),[[V,v(Y).loading]])])),_:1}),f("div",q,[m(d,{background:"","current-page":v(pe).page,"page-size":v(pe).limit,total:v(H),onCurrentChange:ue,onSizeChange:K},null,8,["current-page","page-size","total"])]),m(p,{size:v(G)?"100%":"70%",modelValue:v(Y).dialogVisible,"onUpdate:modelValue":l[6]||(l[6]=e=>v(Y).dialogVisible=e),title:"edit"===v(Y).dialogType?e.$t("修改角色"):e.$t("新建角色")},{footer:g((()=>[m(t,{type:"danger",onClick:l[5]||(l[5]=e=>v(Y).dialogVisible=!1)},{default:g((()=>[y(b(e.$t("取消")),1)])),_:1}),m(t,{type:"primary",onClick:fe},{default:g((()=>[y(b(e.$t("确定")),1)])),_:1})])),default:g((()=>[m(o,{model:v(Y).role,"label-width":"80px","label-position":"left"},{default:g((()=>[m(a,{label:e.$t("角色名")},{default:g((()=>[m(n,{modelValue:v(Y).role.name,"onUpdate:modelValue":l[1]||(l[1]=e=>v(Y).role.name=e),placeholder:e.$t("角色名")},null,8,["modelValue","placeholder"])])),_:1},8,["label"]),m(a,{label:e.$t("角色详情信")},{default:g((()=>[m(n,{modelValue:v(Y).role.description,"onUpdate:modelValue":l[2]||(l[2]=e=>v(Y).role.description=e),autosize:{minRows:2,maxRows:4},type:"textarea",placeholder:e.$t("角色详情信息")},null,8,["modelValue","placeholder"])])),_:1},8,["label"]),1!=v(Y).role.id?(u(),_(a,{key:0,label:e.$t("菜单栏")},{default:g((()=>[m(n,{modelValue:v(Y).filterText,"onUpdate:modelValue":l[3]||(l[3]=e=>v(Y).filterText=e),placeholder:e.$t("输入关键字进行过滤"),style:{width:"300px"}},null,8,["modelValue","placeholder"]),m(t,{onClick:ee},{default:g((()=>[y(b(e.$t("全选")),1)])),_:1})])),_:1},8,["label"])):j("",!0),1!=v(Y).role.id?(u(),_(a,{key:1},{default:g((()=>[m(c,{"default-expand-all":"","check-on-click-node":"",ref_key:"menu_tree",ref:W,"filter-node-method":se,"check-strictly":v(Y).checkStrictly,data:v(Y).routes,props:v(Y).defaultProps,"show-checkbox":"","node-key":"path",class:"permission-tree"},null,8,["check-strictly","data","props"])])),_:1})):j("",!0),1!=v(Y).role.id?(u(),_(a,{key:2,label:e.$t("接口权限")},{default:g((()=>[m(n,{modelValue:v(Y).filterText4Api,"onUpdate:modelValue":l[4]||(l[4]=e=>v(Y).filterText4Api=e),placeholder:e.$t("输入关键字进行过滤"),style:{width:"300px"}},null,8,["modelValue","placeholder"]),m(t,{onClick:le},{default:g((()=>[y(b(e.$t("全选")),1)])),_:1})])),_:1},8,["label"])):j("",!0),1!=v(Y).role.id?(u(),_(a,{key:3},{default:g((()=>[m(c,{"default-expand-all":"","check-on-click-node":"",ref_key:"api_tree",ref:X,"filter-node-method":de,"check-strictly":v(Y).checkStrictly,data:v(Y).apiCfg,props:v(Y).defaultProps4Api,"show-checkbox":"","node-key":"value",class:"permission-tree"},null,8,["check-strictly","data","props"])])),_:1})):j("",!0)])),_:1},8,["model"])])),_:1},8,["size","modelValue","title"])])}}}),[["__scopeId","data-v-8a9c1caa"]]);export{G as default};
