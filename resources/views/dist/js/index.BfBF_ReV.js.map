{"version":3,"file":"index.BfBF_ReV.js","sources":["../../../vue/src/views/notice/index.vue"],"sourcesContent":["<template>\n  <div class=\"app-container\">\n    <!-- 搜索区域 -->\n    <div class=\"search-container\">\n      <div class=\"search-header\" @click=\"toggleSearchForm\">\n        <span>筛选条件</span>\n        <el-icon class=\"toggle-icon\" :class=\"{ 'is-active': !isSearchCollapsed }\">\n          <arrow-down />\n        </el-icon>\n      </div>\n      <el-form\n        ref=\"queryFormRef\"\n        :model=\"queryParams\"\n        :inline=\"true\"\n        label-suffix=\":\"\n        label-width=\"auto\"\n        v-show=\"!isSearchCollapsed\"\n        class=\"search-form\"\n      >\n        <el-form-item label=\"标题\" prop=\"title\">\n          <el-input\n            v-model=\"queryParams.title\"\n            placeholder=\"标题\"\n            clearable\n            @keyup.enter=\"handleQuery\"\n          />\n        </el-form-item>\n\n        <el-form-item label=\"阅读状态\" prop=\"read_type\">\n          <el-select style=\"width: 10rem\" v-model=\"queryParams.read_type\" placeholder=\"请选择阅读状态\" clearable>\n            <el-option label=\"全部\" :value=\"0\" />\n            <el-option label=\"未读\" :value=\"2\" />\n            <el-option label=\"已读\" :value=\"1\" />\n          </el-select>\n        </el-form-item>\n\n        <el-form-item class=\"search-buttons\">\n          <div class=\"button-group\" :class=\"{ 'mobile-buttons': isMobile }\">\n            <el-button type=\"primary\" icon=\"search\" @click=\"handleQuery\">搜索</el-button>\n            <el-button icon=\"refresh\" @click=\"handleResetQuery\">重置</el-button>\n            <el-button type=\"danger\" @click=\"truncate\">清空消息</el-button>\n            <el-button v-loading=\"readLoading\" :disabled=\"selectIds.length == 0\" @click=\"markReadNotice(selectIds)\">标为已读</el-button>\n          </div>\n        </el-form-item>\n      </el-form>\n    </div>\n\n    <el-card shadow=\"hover\" class=\"data-table\">\n      <el-table\n        ref=\"dataTableRef\"\n        :row-key=\"row => row.id\"\n        v-loading=\"loading\"\n        :data=\"pageData\"\n        class=\"data-table__content\"\n        @selection-change=\"handleSelectionChange\"\n        max-height=\"500\"\n      >\n\n        <el-table-column type=\"selection\" width=\"55\" align=\"center\" />\n\n        <el-table-column label=\"通知标题\" prop=\"title\" min-width=\"200\" />\n        <el-table-column align=\"center\" label=\"通知类型\" width=\"150\" v-if=\"!isMobile\">\n          <template #default=\"scope\">\n            <el-tag :type=\"scope.row.level\">{{ scope.row.type }}</el-tag>\n          </template>\n        </el-table-column>\n        <el-table-column align=\"center\" label=\"来源\" prop=\"source\" width=\"150\" v-if=\"!isMobile\" />\n        <el-table-column align=\"center\" label=\"阅读状态\" width=\"100\">\n          <template #default=\"scope\">\n            <el-tag :type=\"scope.row.is_read ? 'success' : 'warning'\">\n              {{ scope.row.is_read ? '已读' : '未读' }}\n            </el-tag>\n          </template>\n        </el-table-column>\n        <el-table-column label=\"发布时间\" width=\"180\" v-if=\"!isMobile\">\n          <template #default=\"scope\">\n            <span>{{ formatISODateTime(scope.row.created) }}</span>\n          </template>\n        </el-table-column>\n        <el-table-column align=\"center\" fixed=\"right\" label=\"操作\" width=\"150\">\n          <template #default=\"scope\">\n            <el-button type=\"primary\" size=\"small\" link @click=\"openDetailDialog(scope.row)\">\n              详情\n            </el-button>\n            <el-button\n              v-if=\"scope.row.btn_jump_url\"\n              size=\"small\"\n              link\n              @click=\"handleJump(scope.row.btn_jump_type,scope.row.btn_jump_url)\"\n            >\n              <template v-if=\"scope.row.btn_desc != ''\">\n                {{scope.row.btn_desc}}\n              </template>\n              <template v-else>\n                跳转\n              </template>\n            </el-button>\n          </template>\n        </el-table-column>\n      </el-table>\n\n      <!-- 分页组件 -->\n      <div class=\"pagination-container\" v-if=\"total > 0\">\n        <el-pagination\n          background\n          :current-page=\"queryParams.page\"\n          :page-size=\"queryParams.page_size\"\n          :page-sizes=\"[10, 20, 30, 50,100,200,500]\"\n          :total=\"total\"\n          :layout=\"isMobile?'pager':'total, sizes, prev, pager, next, jumper'\"\n          @size-change=\"handleSizeChange\"\n          @current-change=\"handleCurrentChange\"\n        />\n      </div>\n    </el-card>\n\n    <!-- 通知公告详情 -->\n    <el-drawer\n      append-to-body\n      v-model=\"detailDialog.visible\"\n      :title=\"currentNotice.title\"\n      :size=\"isMobile ? '90%' : '50%'\"\n      direction=\"rtl\"\n      class=\"notice-drawer\"\n      :before-close=\"closeDetailDialog\"\n    >\n      <div class=\"drawer-content\">\n        <el-descriptions  :column=\"1\" border>\n          <el-descriptions-item width=\"10px\"  label=\"标题\" label-class-name=\"description-label\">\n            <span class=\"description-value\">{{ currentNotice.title }}</span>\n          </el-descriptions-item>\n\n          <el-descriptions-item  label=\"类型\" label-class-name=\"description-label\">\n            <el-tag\n              :type=\"currentNotice.level\"\n              class=\"notice-tag\"\n            >\n              {{ currentNotice.type }}\n            </el-tag>\n          </el-descriptions-item>\n\n          <el-descriptions-item label=\"来源\" label-class-name=\"description-label\">\n            <span class=\"description-value\">{{ currentNotice.source || '无' }}</span>\n          </el-descriptions-item>\n\n          <el-descriptions-item label=\"通知影响范围\" label-class-name=\"description-label\">\n            <span class=\"description-value\">\n              <template v-if=\"currentNotice.target_type == 'all'\">全部用户</template>\n               <template v-if=\"currentNotice.target_type == 'roles'\">指定权限组</template>\n               <template v-if=\"currentNotice.target_type == 'users'\">指定用户</template>\n            </span>\n          </el-descriptions-item>\n\n          <el-descriptions-item label=\"是否定时任务\" label-class-name=\"description-label\">\n            <span  class=\"description-value\">{{currentNotice.is_task==1?'是':'否'}}</span>\n          </el-descriptions-item>\n\n\n          <el-descriptions-item label=\"发布时间\" label-class-name=\"description-label\">\n            <span class=\"description-value\">{{ formatISODateTime(currentNotice.created) }}</span>\n          </el-descriptions-item>\n\n          <el-descriptions-item label=\"内容\" label-class-name=\"description-label\">\n            <div class=\"notice-content\" v-html=\"currentNotice.content\" />\n          </el-descriptions-item>\n        </el-descriptions>\n\n        <div class=\"drawer-footer\">\n          <el-button\n            type=\"primary\"\n            @click=\"closeDetailDialog\"\n            class=\"close-button\"\n          >\n            关闭\n          </el-button>\n\n\n        </div>\n      </div>\n    </el-drawer>\n  </div>\n</template>\n<script setup lang=\"ts\">\nimport { ref, reactive, onMounted, nextTick, computed } from 'vue'\nimport { ElMessage } from 'element-plus'\nimport { GetList, MarkReadNotice,Truncate } from '@/api/notice'\nimport { useNoticeStore} from \"@/store\";\nimport { ArrowDown } from '@element-plus/icons-vue'\n\nconst noticeStore = useNoticeStore();\n\nimport router from \"@/router\";\n\ndefineOptions({\n  name: \"Notice\",\n  inheritAttrs: false,\n});\n\nconst queryFormRef = ref()\nconst loading = ref(false)\nconst total = ref(0)\nconst dataTableRef = ref()\n\n// 移动端适配\nconst isMobile = computed(() => {\n  return window.innerWidth < 768\n})\n\n// 筛选条件收起状态\nconst isSearchCollapsed = ref(isMobile.value)\n\n// 切换筛选表单的显示/隐藏\nfunction toggleSearchForm() {\n  isSearchCollapsed.value = !isSearchCollapsed.value\n}\n\nconst queryParams = reactive({\n  title: '',\n  read_type: 2, // 0:全部 2:未读 1:已读\n  page: 1,\n  page_size: 10\n})\n\n// 通知公告表格数据\nconst pageData = ref([])\n\n// 跨页选中数据：id => row\nconst selectedMap = reactive(new Map<number, any>())\nconst selectIds = computed(() => Array.from(selectedMap.keys()))\n\n// 详情弹窗\nconst detailDialog = reactive({\n  visible: false\n})\nconst currentNotice = ref({})\n\nasync function truncate(){\n  const res = await Truncate({})\n\n  if(res.code == 0){\n    ElMessage.success(res.msg)\n    handleQuery()\n    return\n  }\n  ElMessage.error(res.msg)\n}\n\n// 查询通知公告\nasync function handleQuery() {\n  try {\n    loading.value = true\n    const res = await GetList(queryParams)\n    if (res.code === 0) {\n      pageData.value = res.data.list\n      total.value = res.data.count\n\n      // 回显当前页选中项\n      nextTick(() => {\n        if (dataTableRef.value) {\n          dataTableRef.value.clearSelection() // 清空旧的选择\n          pageData.value.forEach(row => {\n            if (selectedMap.has(row.id)) {\n              dataTableRef.value.toggleRowSelection(row, true)\n            }\n          })\n        }\n      })\n    } else {\n      ElMessage.error(res.msg || '获取通知列表失败')\n    }\n  } catch (error) {\n    console.error('获取通知列表失败:', error)\n    ElMessage.error('获取通知列表失败')\n  } finally {\n    loading.value = false\n  }\n}\n\nfunction formatISODateTime(isoString) {\n  const date = new Date(isoString)\n  if (isNaN(date.getTime())) return '无效日期'\n  const y = date.getFullYear()\n  const m = String(date.getMonth() + 1).padStart(2, '0')\n  const d = String(date.getDate()).padStart(2, '0')\n  const h = String(date.getHours()).padStart(2, '0')\n  const mi = String(date.getMinutes()).padStart(2, '0')\n  const s = String(date.getSeconds()).padStart(2, '0')\n  return `${y}-${m}-${d} ${h}:${mi}:${s}`\n}\n\nfunction handleResetQuery() {\n  queryFormRef.value.resetFields()\n  queryParams.page = 1\n  handleQuery()\n}\n\nfunction handleSizeChange(val: number) {\n  queryParams.page_size = val\n  handleQuery()\n}\n\nfunction handleCurrentChange(val: number) {\n  queryParams.page = val\n  handleQuery()\n}\n\nconst readLoading = ref(false)\n\nasync function markReadNotice(ids: number[]) {\n  readLoading.value = true\n  await noticeStore.markAsRead(ids);\n  readLoading.value = false\n  ids.forEach(id => selectedMap.delete(id)) // 清除已读项\n  handleQuery()\n}\n\nfunction handleSelectionChange(selection: any[]) {\n  /*const currentPageIds = pageData.value.map(item => item.id)\n  // 清除当前页的选中项\n  currentPageIds.forEach(id => selectedMap.delete(id))*/\n  // 添加当前页新的选中项\n\n  selection.forEach(item => {\n    selectedMap.set(item.id, item)\n  })\n}\n\nfunction openDetailDialog(row: any) {\n  currentNotice.value = row\n  detailDialog.visible = true\n  if (!row.is_read) {\n    markReadNotice([row.id])\n  }\n}\n\nfunction closeDetailDialog() {\n  detailDialog.visible = false\n  currentNotice.value = {}\n}\n\nfunction handleJump(typ: string, url: string) {\n  if (typ === 'internal') {\n    router.push({ path: url })\n  } else {\n    window.open(url, '_blank')\n  }\n}\n\nonMounted(() => {\n  handleQuery()\n  \n  // 监听窗口大小变化\n  window.addEventListener('resize', () => {\n    if (isMobile.value) {\n      isSearchCollapsed.value = true\n    }\n  })\n})\n</script>\n<style scoped>\n.notice-content {\n  padding: 10px;\n  background: #f5f5f5;\n  border-radius: 4px;\n}\n\n/* 新增移动端适配样式 */\n.search-container {\n  margin-bottom: 15px;\n  border: 1px solid var(--el-border-color-light);\n  border-radius: 4px;\n  background-color: var(--el-bg-color);\n}\n\n.search-header {\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  padding: 10px 15px;\n  cursor: pointer;\n  border-bottom: 1px solid var(--el-border-color-lighter);\n  font-weight: bold;\n}\n\n.toggle-icon {\n  transition: transform 0.3s;\n}\n\n.toggle-icon.is-active {\n  transform: rotate(180deg);\n}\n\n.search-form {\n  padding: 15px;\n}\n\n.button-group {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 10px;\n}\n\n.mobile-buttons {\n  flex-direction: column;\n  width: 100%;\n}\n\n.mobile-buttons .el-button {\n  width: 100%;\n  margin-left: 0;\n}\n\n@media screen and (max-width: 768px) {\n  .search-form :deep(.el-form-item) {\n    margin-bottom: 10px;\n    width: 100%;\n  }\n  \n  .search-form :deep(.el-form-item__content) {\n    width: 100%;\n  }\n  \n  .search-form :deep(.el-input),\n  .search-form :deep(.el-select) {\n    width: 100% !important;\n  }\n  \n  .pagination-container {\n    overflow-x: auto;\n  }\n}\n</style>\n<style scoped>\n.notice-drawer {\n  --el-drawer-padding-primary: 20px;\n  --el-drawer-bg-color: var(--el-bg-color);\n  --el-drawer-title-font-size: 18px;\n}\n\n.drawer-content {\n  padding: 0 20px;\n  height: calc(100% - 60px);\n  overflow-y: auto;\n}\n\n.description-label {\n  width: 100px;\n  font-weight: bold;\n  color: var(--el-text-color-regular);\n}\n\n.description-value {\n  color: var(--el-text-color-primary);\n}\n\n.notice-tag {\n  font-size: 14px;\n  padding: 0 10px;\n  height: 28px;\n  line-height: 28px;\n}\n\n.notice-content {\n  padding: 15px;\n  background: var(--el-bg-color-page);\n  border-radius: 4px;\n  line-height: 1.6;\n  color: var(--el-text-color-primary);\n  border: 1px solid var(--el-border-color-light);\n}\n\n.notice-content :deep(p) {\n  margin: 0 0 10px 0;\n}\n\n.notice-content :deep(a) {\n  color: var(--el-color-primary);\n  text-decoration: none;\n}\n\n.notice-content :deep(a:hover) {\n  text-decoration: underline;\n}\n\n.drawer-footer {\n  margin-top: 20px;\n  text-align: right;\n  padding: 10px 0;\n  border-top: 1px solid var(--el-border-color-light);\n}\n\n.close-button {\n  width: 100px;\n}\n\n/* 暗夜模式特定样式 */\n:root.dark .notice-content {\n  background: var(--el-bg-color-overlay);\n  border-color: var(--el-border-color);\n}\n\n:root.dark .drawer-footer {\n  border-top-color: var(--el-border-color);\n}\n\n/* 移动端弹窗适配 */\n@media screen and (max-width: 768px) {\n  .notice-drawer :deep(.el-drawer__header) {\n    padding: 12px 15px;\n    margin-bottom: 10px;\n    font-size: 16px;\n  }\n  \n  .drawer-content {\n    padding: 0 10px;\n  }\n  \n  .close-button {\n    width: 100%;\n  }\n  \n  .notice-drawer :deep(.el-descriptions__label) {\n    padding: 8px;\n  }\n  \n  .notice-drawer :deep(.el-descriptions__content) {\n    padding: 8px;\n  }\n}\n</style>\n"],"names":["noticeStore","useNoticeStore","queryFormRef","ref","loading","total","dataTableRef","isMobile","computed","window","innerWidth","isSearchCollapsed","value","toggleSearchForm","queryParams","reactive","title","read_type","page","page_size","pageData","selectedMap","Map","selectIds","Array","from","keys","detailDialog","visible","currentNotice","async","truncate","res","Truncate","code","ElMessage","success","msg","error","handleQuery","GetList","data","list","count","nextTick","clearSelection","forEach","row","has","id","toggleRowSelection","console","formatISODateTime","isoString","date","Date","isNaN","getTime","getFullYear","String","getMonth","padStart","getDate","getHours","getMinutes","getSeconds","handleResetQuery","resetFields","handleSizeChange","val","handleCurrentChange","readLoading","markReadNotice","ids","markAsRead","delete","handleSelectionChange","selection","item","set","closeDetailDialog","onMounted","addEventListener","is_read","typ","url","router","push","path","open"],"mappings":"y+CA6LA,MAAMA,EAAcC,IASdC,EAAeC,IACfC,EAAUD,GAAI,GACdE,GAAQF,EAAI,GACZG,GAAeH,IAGfI,GAAWC,GAAS,IACjBC,OAAOC,WAAa,MAIvBC,GAAoBR,EAAII,GAASK,OAGvC,SAASC,KACWF,GAAAC,OAASD,GAAkBC,KAC/C,CAEA,MAAME,GAAcC,EAAS,CAC3BC,MAAO,GACPC,UAAW,EACXC,KAAM,EACNC,UAAW,KAIPC,GAAWjB,EAAI,IAGfkB,GAAcN,EAAa,IAAAO,KAC3BC,GAAYf,GAAS,IAAMgB,MAAMC,KAAKJ,GAAYK,UAGlDC,GAAeZ,EAAS,CAC5Ba,SAAS,IAELC,GAAgB1B,EAAI,CAAA,GAE1B2B,eAAeC,KACb,MAAMC,QAAYC,EAAS,CAAA,GAExB,GAAY,GAAZD,EAAIE,KAGL,OAFUC,EAAAC,QAAQJ,EAAIK,eAIdF,EAAAG,MAAMN,EAAIK,IACtB,CAGAP,eAAeS,KACT,IACFnC,EAAQQ,OAAQ,EACV,MAAAoB,QAAYQ,EAAQ1B,IACT,IAAbkB,EAAIE,MACGd,GAAAR,MAAQoB,EAAIS,KAAKC,KACpBrC,GAAAO,MAAQoB,EAAIS,KAAKE,MAGvBC,GAAS,KACHtC,GAAaM,QACfN,GAAaM,MAAMiC,iBACVzB,GAAAR,MAAMkC,SAAeC,IACxB1B,GAAY2B,IAAID,EAAIE,KACT3C,GAAAM,MAAMsC,mBAAmBH,GAAK,EAC7C,IAEJ,KAGQZ,EAAAG,MAAMN,EAAIK,KAAO,kBAEtBC,GACCa,QAAAb,MAAM,YAAaA,GAC3BH,EAAUG,MAAM,WAAU,CAC1B,QACAlC,EAAQQ,OAAQ,CAClB,CACF,CAEA,SAASwC,GAAkBC,GACnB,MAAAC,EAAO,IAAIC,KAAKF,GACtB,GAAIG,MAAMF,EAAKG,WAAmB,MAAA,OAO3B,MAAA,GANGH,EAAKI,iBACLC,OAAOL,EAAKM,WAAa,GAAGC,SAAS,EAAG,QACxCF,OAAOL,EAAKQ,WAAWD,SAAS,EAAG,QACnCF,OAAOL,EAAKS,YAAYF,SAAS,EAAG,QACnCF,OAAOL,EAAKU,cAAcH,SAAS,EAAG,QACvCF,OAAOL,EAAKW,cAAcJ,SAAS,EAAG,MAElD,CAEA,SAASK,KACPhE,EAAaU,MAAMuD,cACnBrD,GAAYI,KAAO,MAErB,CAEA,SAASkD,GAAiBC,GACxBvD,GAAYK,UAAYkD,MAE1B,CAEA,SAASC,GAAoBD,GAC3BvD,GAAYI,KAAOmD,MAErB,CAEM,MAAAE,GAAcpE,GAAI,GAExB2B,eAAe0C,GAAeC,GAC5BF,GAAY3D,OAAQ,QACdZ,EAAY0E,WAAWD,GAC7BF,GAAY3D,OAAQ,EACpB6D,EAAI3B,SAAQG,GAAM5B,GAAYsD,OAAO1B,SAEvC,CAEA,SAAS2B,GAAsBC,GAMnBA,EAAA/B,SAAgBgC,IACZzD,GAAA0D,IAAID,EAAK7B,GAAI6B,EAAI,GAEjC,CAUA,SAASE,KACPrD,GAAaC,SAAU,EACvBC,GAAcjB,MAAQ,EACxB,QAUAqE,GAAU,UAIDxE,OAAAyE,iBAAiB,UAAU,KAC5B3E,GAASK,QACXD,GAAkBC,OAAQ,EAC5B,GACD,i8EA7BuBmC,QACxBlB,GAAcjB,MAAQmC,EACtBpB,GAAaC,SAAU,OAClBmB,EAAIoC,SACQX,GAAA,CAACzB,EAAIE,MAJxB,IAA0BF,oIAaNqC,sBAAaC,0BACnB,aAARD,EACFE,EAAOC,KAAK,CAAEC,KAAMH,IAEb5E,OAAAgF,KAAKJ,EAAK,WAJZ,IAAWD,EAAaC"}