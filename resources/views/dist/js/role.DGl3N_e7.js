import{b6 as e,d as l,aP as a,c as t,aU as o,r as s,a0 as i,ci as r,J as d,o as n,cj as c,aG as p,e as u,h as f,C as m,g as h,l as g,w as b,a9 as y,i as _,p as k,a7 as v,F as w,a3 as C,f as x,j as V,bL as j,bM as $,aH as A,a2 as T,aX as N,b4 as S,E,a5 as U,a6 as O,b9 as M,b0 as R,b1 as L}from"./index.W33FBolP.js";import{E as z}from"./el-loading.DTgwG8UQ.js";import{E as P,a as J}from"./el-tab-pane.DAaixt0V.js";import{E as B}from"./el-tree.BHNEtQTL.js";import"./el-checkbox.IUVBXYid.js";import{E as D}from"./el-pagination.CbGKzv28.js";/* empty css               */import"./el-select.D5pkIrdC.js";import"./el-scrollbar.CF952IsS.js";import"./el-tooltip.Dj6yvCEN.js";import{E as I}from"./el-card.CAShaOk8.js";import{E as F,a as G}from"./el-table-column.C7pSay8D.js";import{a as H,E as K}from"./el-form.yboLIzGg.js";import"./el-form-item.l0sNRNKZ.js";import{d as X}from"./index.B6fdKp2E.js";import{U as q}from"./api-rbac.Bk8aqWdI.js";import{_ as Q}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./use-dialog.Uu3kEZll.js";import"./isUndefined.DgmxjSXK.js";import"./strings.Dd75Su9I.js";import"./index.CwuhdP3B.js";import"./index.BlQRGALI.js";import"./_Uint8Array.DOwfnrpH.js";const W={class:"app-container"},Y=(e=>(R("data-v-cb4db315"),e=e(),L(),e))((()=>m("span",null,"搜索条件",-1))),Z={class:"pagination-container"},ee={class:"permission-header"},le={class:"permission-header"},ae={class:"drawer-footer"},te=Q(l({__name:"role",setup(l){const R=a(),L=t((()=>R.device===o.MOBILE)),Q=s(0),te=e=>{ve.limit=e,we(1)},oe={id:"",name:"",description:"",routes:[],api:[]},se=i({role_name:""}),ie=i({asyncRoutes:r,allAsyncRoutes:[],editLinkRoleId:0,loading:!1,allApiConfig:[],value:[],filterMethod:(e,l)=>l.label.indexOf(e)>-1,urlConfig:[],urlConfigMap:[],filterText:"",filterText4Api:"",role:Object.assign({},oe),routes:[],rolesList:[],dialogVisible:!1,esLinkDialogVisible:!1,dialogType:"new",checkStrictly:!1,defaultProps:{children:"children",label:"title"},defaultProps4Api:{children:"options",label:"label"},chanCfgList:[],apiCfg:[],selectAllApiCfg:[],apiMap:{},data:[]}),re=s(),de=s();d(ie.filterText,(e=>{re.value.filter(e)})),d(ie.filterText4Api,(e=>{de.value.filter(e)})),n((async()=>{await ne(),ue(),we(1)}));const ne=async()=>{let e=await q({need_auth:!0});if(0==e.code){let l=JSON.parse(JSON.stringify(e.data.cfg_with_module)),a=l.length;for(;a--;){let e=l[a],t=e.options.length,o=e.options;for(;t--;)o[t].needAuth||o.splice(t,1),0==o.length&&l.splice(a,1)}ie.apiMap={},ie.selectAllApiCfg=[];for(let e of l)for(let l of e.options)ie.selectAllApiCfg.push(l),ie.apiMap[l.value]=l;ie.apiCfg=l}},ce=()=>{re.value.setCheckedNodes(ie.routes)},pe=()=>{de.value.setCheckedNodes(ie.selectAllApiCfg)},ue=async()=>{let e=await c({routers:r});ie.allAsyncRoutes=e.data;var l=e.data;ie.routes=me(l)},fe=(e=[],l)=>{let a=null;const t=e.filter((e=>!e.hidden));return 1===t.length?(a=t[0],a.path=p.resolve(l.path,a.path),a):0===t.length&&(a={...l,path:"",noShowingChildren:!0},a)},me=(e,l="/")=>{const a=[];for(let t of e){if(t.hidden&&!t.service)continue;const e=fe(t.children,t);t.children&&t.children.length>0&&e&&!t.alwaysShow&&(t=e);const o={path:p.resolve(l,t.path),title:t.meta&&t.meta.title};t.children&&t.children.length>0&&(o.children=me(t.children,o.path)),a.push(o)}return a},he=e=>{let l=[];return e.forEach((e=>{if(l.push(e),e.children&&e.children.length>0){const a=he(e.children);a.length>0&&(l=[...l,...a])}})),l},ge=(e,l="/",a)=>{const t=[];for(const o of e)o.children&&o.children.length>0&&(o.children=ge(o.children,p.resolve(l,o.path),a)),(a.includes(p.resolve(l,o.path))||o.children&&o.children.length>=1)&&t.push(o);return t},be=(e,l)=>!e||-1!==l.title.indexOf(e),ye=(e,l)=>!e||-1!==l.label.indexOf(e),_e=()=>{ie.role=Object.assign({},oe),re.value&&re.value.setCheckedNodes([]),de.value&&de.value.setCheckedNodes([]),ie.dialogType="new",ie.dialogVisible=!0},ke=e=>{ie.dialogType="edit",ie.dialogVisible=!0,ie.checkStrictly=!0,ie.role=X(e),T((()=>{const e=me(ie.role.routes);re.value.setCheckedNodes(he(e));let l=[];for(let a of ie.role.api)l.push(ie.apiMap[a]);de.value&&de.value.setCheckedNodes(l),ie.checkStrictly=!1}))},ve=i({page:1,limit:10}),we=async l=>{ve.page=l||1,ie.loading=!0;const a=await(t={role_name:se.role_name,page:l,page_size:ve.limit},e({url:"/api/gm_user/roles",method:"post",data:t}));var t;for(var o in ie.loading=!1,a.data.list)a.data.list[o].routes=JSON.parse(a.data.list[o].routes);Q.value=a.data.count,ie.rolesList=a.data.list},Ce=({$index:l,row:a})=>{N.confirm("确定删除这个角色吗?","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((async()=>{let l=await(t={id:a.id},e({url:"/api/gm_user/role/delete",method:"post",data:t}));var t;0==l.code?(await we(1),0==l.code?S.success({type:"success",offset:60,message:l.msg}):S.error({type:"error",offset:60,message:l.msg})):S.error({type:"error",offset:60,message:l.msg})})).catch((e=>{console.error(e)}))},xe=async()=>{if(de.value){const e=de.value.getCheckedNodes(!0,!1);let l=[];for(let a of e)l.push(a.value);ie.role.api=l}const l="edit"===ie.dialogType,a=re.value.getCheckedKeys();ie.role.routes=ge(X(ie.allAsyncRoutes),"/",a);var t=ie.role;if(""!=t.name.trim()){if(t.routes=JSON.stringify(t.routes),l){t.id=ie.role.id;let l=await(o=t,e({url:"/api/gm_user/role/update",method:"post",data:o}));if(0!=l.code)return void S.error({type:"error",offset:60,message:l.msg});we(1)}else{t.id=0;const l=await function(l){return e({url:"/api/gm_user/role/add",method:"post",data:l})}(t);if(0!=l.code)return void S.error({type:"error",offset:60,message:l.msg});we(1)}var o;ie.dialogVisible=!1,S.success({type:"success",offset:60,message:"操作成功"})}else S.error({type:"error",offset:60,message:"角色名不能为空"})},Ve=s("basic"),je=s(!0),$e=()=>{je.value=!je.value};return(e,l)=>{const a=E,t=U,o=H,s=O,i=K,r=F,d=G,n=I,c=D,p=P,T=B,N=J,S=z,R=M;return u(),f("div",W,[m("div",{class:_(["search-container",{"is-collapsed":h(je)&&h(L)}])},[h(L)?(u(),f("div",{key:0,class:"search-header",onClick:$e},[Y,g(a,{class:_({"is-collapsed":h(je)})},{default:b((()=>[g(h(y))])),_:1},8,["class"])])):k("",!0),g(i,{inline:!0},{default:b((()=>[g(o,{label:"角色名:",prop:"keywords"},{default:b((()=>[g(t,{clearable:"",modelValue:h(se).role_name,"onUpdate:modelValue":l[0]||(l[0]=e=>h(se).role_name=e),style:{width:"160px"}},null,8,["modelValue"])])),_:1}),g(o,{class:"button-group"},{default:b((()=>[g(s,{type:"success",class:"filter-item",onClick:l[1]||(l[1]=e=>we(1))},{default:b((()=>[v(w(e.$t("搜索")),1)])),_:1}),g(s,{type:"warning",class:"filter-item",onClick:_e},{default:b((()=>[v(w(e.$t("新增")),1)])),_:1})])),_:1})])),_:1})],2),g(n,{shadow:"never",class:"table-container"},{default:b((()=>[C((u(),x(d,{data:h(ie).rolesList,onRowDblclick:ke},{default:b((()=>[g(r,{align:"center",label:e.$t("id"),width:"40"},{default:b((e=>[v(w(e.row.id),1)])),_:1},8,["label"]),g(r,{align:"center",label:e.$t("角色名"),width:"200"},{default:b((e=>[v(w(e.row.name),1)])),_:1},8,["label"]),g(r,{align:"header-center",label:e.$t("备注")},{default:b((e=>[v(w(e.row.description),1)])),_:1},8,["label"]),g(r,{align:"center",label:e.$t("操作"),width:"140",fixed:"right"},{default:b((e=>[g(s,{type:"primary",onClick:V((l=>ke(e.row)),["stop"]),icon:h(j)},null,8,["onClick","icon"]),g(s,{type:"danger",onClick:V((l=>Ce(e)),["stop"]),icon:h($)},null,8,["onClick","icon"])])),_:1},8,["label"])])),_:1},8,["data"])),[[R,h(ie).loading]])])),_:1}),m("div",Z,[g(c,{background:"","current-page":h(ve).page,"page-size":h(ve).limit,total:h(Q),onCurrentChange:we,onSizeChange:te},null,8,["current-page","page-size","total"])]),g(S,{size:h(L)?"100%":"70%",modelValue:h(ie).dialogVisible,"onUpdate:modelValue":l[8]||(l[8]=e=>h(ie).dialogVisible=e),title:"edit"===h(ie).dialogType?e.$t("修改角色"):e.$t("新建角色")},{footer:b((()=>[m("div",ae,[g(s,{type:"danger",onClick:l[7]||(l[7]=e=>h(ie).dialogVisible=!1)},{default:b((()=>[v(w(e.$t("取消")),1)])),_:1}),g(s,{type:"primary",onClick:xe},{default:b((()=>[v(w(e.$t("确定")),1)])),_:1})])])),default:b((()=>[g(N,{modelValue:h(Ve),"onUpdate:modelValue":l[6]||(l[6]=e=>A(Ve)?Ve.value=e:null)},{default:b((()=>[g(p,{label:e.$t("基本信息"),name:"basic"},{default:b((()=>[g(i,{model:h(ie).role,"label-width":"80px","label-position":"left"},{default:b((()=>[g(o,{label:e.$t("角色名")},{default:b((()=>[g(t,{modelValue:h(ie).role.name,"onUpdate:modelValue":l[2]||(l[2]=e=>h(ie).role.name=e),placeholder:e.$t("角色名")},null,8,["modelValue","placeholder"])])),_:1},8,["label"]),g(o,{label:e.$t("备注")},{default:b((()=>[g(t,{modelValue:h(ie).role.description,"onUpdate:modelValue":l[3]||(l[3]=e=>h(ie).role.description=e),autosize:{minRows:2,maxRows:4},type:"textarea",placeholder:e.$t("备注")},null,8,["modelValue","placeholder"])])),_:1},8,["label"])])),_:1},8,["model"])])),_:1},8,["label"]),1!=h(ie).role.id?(u(),x(p,{key:0,label:e.$t("菜单权限"),name:"menu"},{default:b((()=>[m("div",ee,[g(t,{modelValue:h(ie).filterText,"onUpdate:modelValue":l[4]||(l[4]=e=>h(ie).filterText=e),placeholder:e.$t("输入关键字进行过滤"),class:"filter-input"},null,8,["modelValue","placeholder"]),g(s,{onClick:ce},{default:b((()=>[v(w(e.$t("全选")),1)])),_:1})]),g(T,{"default-expand-all":"","check-on-click-node":"",ref_key:"menu_tree",ref:re,"filter-node-method":be,"check-strictly":h(ie).checkStrictly,data:h(ie).routes,props:h(ie).defaultProps,"show-checkbox":"","node-key":"path",class:"permission-tree"},null,8,["check-strictly","data","props"])])),_:1},8,["label"])):k("",!0),1!=h(ie).role.id?(u(),x(p,{key:1,label:e.$t("接口权限"),name:"api"},{default:b((()=>[m("div",le,[g(t,{modelValue:h(ie).filterText4Api,"onUpdate:modelValue":l[5]||(l[5]=e=>h(ie).filterText4Api=e),placeholder:e.$t("输入关键字进行过滤"),class:"filter-input"},null,8,["modelValue","placeholder"]),g(s,{onClick:pe},{default:b((()=>[v(w(e.$t("全选")),1)])),_:1})]),g(T,{"default-expand-all":"","check-on-click-node":"",ref_key:"api_tree",ref:de,"filter-node-method":ye,"check-strictly":h(ie).checkStrictly,data:h(ie).apiCfg,props:h(ie).defaultProps4Api,"show-checkbox":"","node-key":"value",class:"permission-tree"},null,8,["check-strictly","data","props"])])),_:1},8,["label"])):k("",!0)])),_:1},8,["modelValue"])])),_:1},8,["size","modelValue","title"])])}}}),[["__scopeId","data-v-cb4db315"]]);export{te as default};
//# sourceMappingURL=role.DGl3N_e7.js.map
