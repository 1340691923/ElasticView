import{b7 as e,d as l,aQ as a,c as t,aV as o,r as i,a0 as r,cb as s,J as d,o as n,cc as c,aJ as p,e as u,h as f,C as h,l as m,w as g,g as y,a7 as b,F as k,a3 as _,f as v,j as w,bI as x,bJ as C,p as V,a2 as j,aY as A,b5 as $,a5 as T,a6 as S,ba as N}from"./index.DhFaMfT1.js";/* empty css                   */import{E as O}from"./el-drawer.DcGaWt7a.js";import{E}from"./el-tree.C2Y9afcv.js";import"./el-checkbox.KVZb2vWH.js";import{E as U}from"./el-pagination.Brn4GqVi.js";/* empty css               */import"./el-select.KghQrqPV.js";import"./el-scrollbar.aDuaURpM.js";import"./el-tooltip.DNk7uouO.js";import{E as R}from"./el-card.DLuvqNHd.js";import{E as z,a as J}from"./el-table-column.DooLdcCD.js";import{a as L,E as M}from"./el-form.DQSmj6L_.js";import"./el-form-item.l0sNRNKZ.js";import{d as B}from"./index.B6fdKp2E.js";import{U as I}from"./api-rbac.BHkFkEbD.js";import{_ as P}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./use-dialog.dDo3P1Pb.js";import"./isUndefined.DgmxjSXK.js";import"./index.BDgBryKB.js";import"./strings.BIH3i9Us.js";import"./index.DdIe-2Yd.js";import"./_Uint8Array.DfkEojHH.js";const D={class:"app-container"},F={class:"search-container"},q={class:"pagination-container"},G=P(l({__name:"role",setup(l){const P=a(),G=t((()=>P.device===o.MOBILE)),H=i(0),K=e=>{ue.limit=e,fe(1)},Q={id:"",name:"",description:"",routes:[],api:[]},Y=r({role_name:""}),W=r({asyncRoutes:s,allAsyncRoutes:[],editLinkRoleId:0,loading:!1,allApiConfig:[],value:[],filterMethod:(e,l)=>l.label.indexOf(e)>-1,urlConfig:[],urlConfigMap:[],filterText:"",filterText4Api:"",role:Object.assign({},Q),routes:[],rolesList:[],dialogVisible:!1,esLinkDialogVisible:!1,dialogType:"new",checkStrictly:!1,defaultProps:{children:"children",label:"title"},defaultProps4Api:{children:"options",label:"label"},chanCfgList:[],apiCfg:[],selectAllApiCfg:[],apiMap:{},data:[]}),X=i(),Z=i();d(W.filterText,(e=>{X.value.filter(e)})),d(W.filterText4Api,(e=>{Z.value.filter(e)})),n((async()=>{await ee(),te(),fe(1)}));const ee=async()=>{let e=await I({need_auth:!0});if(0==e.code){let l=JSON.parse(JSON.stringify(e.data.cfg_with_module)),a=l.length;for(;a--;){let e=l[a],t=e.options.length,o=e.options;for(;t--;)o[t].needAuth||o.splice(t,1),0==o.length&&l.splice(a,1)}W.apiMap={},W.selectAllApiCfg=[];for(let e of l)for(let l of e.options)W.selectAllApiCfg.push(l),W.apiMap[l.value]=l;W.apiCfg=l}},le=()=>{X.value.setCheckedNodes(W.routes)},ae=()=>{Z.value.setCheckedNodes(W.selectAllApiCfg)},te=async()=>{let e=await c({routers:s});W.allAsyncRoutes=e.data;var l=e.data;W.routes=ie(l)},oe=(e=[],l)=>{let a=null;const t=e.filter((e=>!e.hidden));return 1===t.length?(a=t[0],a.path=p.resolve(l.path,a.path),a):0===t.length&&(a={...l,path:"",noShowingChildren:!0},a)},ie=(e,l="/")=>{const a=[];for(let t of e){if(t.hidden&&!t.service)continue;const e=oe(t.children,t);t.children&&t.children.length>0&&e&&!t.alwaysShow&&(t=e);const o={path:p.resolve(l,t.path),title:t.meta&&t.meta.title};t.children&&t.children.length>0&&(o.children=ie(t.children,o.path)),a.push(o)}return a},re=e=>{let l=[];return e.forEach((e=>{if(l.push(e),e.children&&e.children.length>0){const a=re(e.children);a.length>0&&(l=[...l,...a])}})),l},se=(e,l="/",a)=>{const t=[];for(const o of e)o.children&&o.children.length>0&&(o.children=se(o.children,p.resolve(l,o.path),a)),(a.includes(p.resolve(l,o.path))||o.children&&o.children.length>=1)&&t.push(o);return t},de=(e,l)=>!e||-1!==l.title.indexOf(e),ne=(e,l)=>!e||-1!==l.label.indexOf(e),ce=()=>{W.role=Object.assign({},Q),X.value&&X.value.setCheckedNodes([]),Z.value&&Z.value.setCheckedNodes([]),W.dialogType="new",W.dialogVisible=!0},pe=e=>{W.dialogType="edit",W.dialogVisible=!0,W.checkStrictly=!0,W.role=B(e),j((()=>{const e=ie(W.role.routes);X.value.setCheckedNodes(re(e));let l=[];for(let a of W.role.api)l.push(W.apiMap[a]);Z.value&&Z.value.setCheckedNodes(l),W.checkStrictly=!1}))},ue=r({page:1,limit:10}),fe=async l=>{ue.page=l||1,W.loading=!0;const a=await(t={role_name:Y.role_name,page:l,page_size:ue.limit},e({url:"/api/gm_user/roles",method:"post",data:t}));var t;for(var o in W.loading=!1,a.data.list)a.data.list[o].routes=JSON.parse(a.data.list[o].routes);H.value=a.data.count,W.rolesList=a.data.list},he=({$index:l,row:a})=>{A.confirm("确定删除这个角色吗?","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((async()=>{let l=await(t={id:a.id},e({url:"/api/gm_user/role/delete",method:"post",data:t}));var t;0==l.code?(await fe(1),0==l.code?$.success({type:"success",message:l.msg}):$.error({type:"error",message:l.msg})):$.error({type:"error",message:l.msg})})).catch((e=>{console.error(e)}))},me=async()=>{if(Z.value){const e=Z.value.getCheckedNodes(!0,!1);let l=[];for(let a of e)l.push(a.value);W.role.api=l}const l="edit"===W.dialogType,a=X.value.getCheckedKeys();W.role.routes=se(B(W.allAsyncRoutes),"/",a);var t,o=W.role;if(o.routes=JSON.stringify(o.routes),l){o.id=W.role.id;let l=await(t=o,e({url:"/api/gm_user/role/update",method:"post",data:t}));if(0!=l.code)return void $.error({type:"error",message:l.msg});fe(1)}else{o.id=0;const l=await function(l){return e({url:"/api/gm_user/role/add",method:"post",data:l})}(o);if(0!=l.code)return void $.error({type:"error",message:l.msg});fe(1)}W.dialogVisible=!1,$.success({type:"success",message:"操作成功"})};return(e,l)=>{const a=T,t=S,o=L,i=M,r=z,s=J,d=R,n=U,c=E,p=O,j=N;return u(),f("div",D,[h("div",F,[m(i,{inline:!0},{default:g((()=>[m(o,{label:"角色名:",prop:"keywords"},{default:g((()=>[m(a,{clearable:"",modelValue:y(Y).role_name,"onUpdate:modelValue":l[0]||(l[0]=e=>y(Y).role_name=e),style:{width:"160px"}},null,8,["modelValue"]),m(t,{style:{"margin-left":"10px"},type:"success",class:"filter-item",onClick:l[1]||(l[1]=e=>fe(1))},{default:g((()=>[b(k(e.$t("搜索")),1)])),_:1})])),_:1}),m(o,{label:"",prop:"keywords"},{default:g((()=>[m(t,{type:"warning",class:"filter-item",onClick:ce},{default:g((()=>[b(k(e.$t("新增")),1)])),_:1})])),_:1})])),_:1})]),m(d,{shadow:"never",class:"table-container"},{default:g((()=>[_((u(),v(s,{data:y(W).rolesList,onRowDblclick:pe},{default:g((()=>[m(r,{align:"center",label:e.$t("id"),width:"40"},{default:g((e=>[b(k(e.row.id),1)])),_:1},8,["label"]),m(r,{align:"center",label:e.$t("角色名"),width:"200"},{default:g((e=>[b(k(e.row.name),1)])),_:1},8,["label"]),m(r,{align:"header-center",label:e.$t("角色详细信息")},{default:g((e=>[b(k(e.row.description),1)])),_:1},8,["label"]),m(r,{align:"center",label:e.$t("操作"),width:"140",fixed:"right"},{default:g((e=>[m(t,{type:"primary",onClick:w((l=>pe(e.row)),["stop"]),icon:y(x)},null,8,["onClick","icon"]),m(t,{type:"danger",onClick:w((l=>he(e)),["stop"]),icon:y(C)},null,8,["onClick","icon"])])),_:1},8,["label"])])),_:1},8,["data"])),[[j,y(W).loading]])])),_:1}),h("div",q,[m(n,{background:"","current-page":y(ue).page,"page-size":y(ue).limit,total:y(H),onCurrentChange:fe,onSizeChange:K},null,8,["current-page","page-size","total"])]),m(p,{size:y(G)?"100%":"70%",modelValue:y(W).dialogVisible,"onUpdate:modelValue":l[7]||(l[7]=e=>y(W).dialogVisible=e),title:"edit"===y(W).dialogType?e.$t("修改角色"):e.$t("新建角色")},{footer:g((()=>[m(t,{type:"danger",onClick:l[6]||(l[6]=e=>y(W).dialogVisible=!1)},{default:g((()=>[b(k(e.$t("取消")),1)])),_:1}),m(t,{type:"primary",onClick:me},{default:g((()=>[b(k(e.$t("确定")),1)])),_:1})])),default:g((()=>[m(i,{model:y(W).role,"label-width":"80px","label-position":"left"},{default:g((()=>[m(o,{label:e.$t("角色名")},{default:g((()=>[m(a,{modelValue:y(W).role.name,"onUpdate:modelValue":l[2]||(l[2]=e=>y(W).role.name=e),placeholder:e.$t("角色名")},null,8,["modelValue","placeholder"])])),_:1},8,["label"]),m(o,{label:e.$t("角色详情信")},{default:g((()=>[m(a,{modelValue:y(W).role.description,"onUpdate:modelValue":l[3]||(l[3]=e=>y(W).role.description=e),autosize:{minRows:2,maxRows:4},type:"textarea",placeholder:e.$t("角色详情信息")},null,8,["modelValue","placeholder"])])),_:1},8,["label"]),1!=y(W).role.id?(u(),v(o,{key:0,label:e.$t("菜单栏")},{default:g((()=>[m(a,{modelValue:y(W).filterText,"onUpdate:modelValue":l[4]||(l[4]=e=>y(W).filterText=e),placeholder:e.$t("输入关键字进行过滤"),style:{width:"300px"}},null,8,["modelValue","placeholder"]),m(t,{onClick:le},{default:g((()=>[b(k(e.$t("全选")),1)])),_:1})])),_:1},8,["label"])):V("",!0),1!=y(W).role.id?(u(),v(o,{key:1},{default:g((()=>[m(c,{"default-expand-all":"","check-on-click-node":"",ref_key:"menu_tree",ref:X,"filter-node-method":de,"check-strictly":y(W).checkStrictly,data:y(W).routes,props:y(W).defaultProps,"show-checkbox":"","node-key":"path",class:"permission-tree"},null,8,["check-strictly","data","props"])])),_:1})):V("",!0),1!=y(W).role.id?(u(),v(o,{key:2,label:e.$t("接口权限")},{default:g((()=>[m(a,{modelValue:y(W).filterText4Api,"onUpdate:modelValue":l[5]||(l[5]=e=>y(W).filterText4Api=e),placeholder:e.$t("输入关键字进行过滤"),style:{width:"300px"}},null,8,["modelValue","placeholder"]),m(t,{onClick:ae},{default:g((()=>[b(k(e.$t("全选")),1)])),_:1})])),_:1},8,["label"])):V("",!0),1!=y(W).role.id?(u(),v(o,{key:3},{default:g((()=>[m(c,{"default-expand-all":"","check-on-click-node":"",ref_key:"api_tree",ref:Z,"filter-node-method":ne,"check-strictly":y(W).checkStrictly,data:y(W).apiCfg,props:y(W).defaultProps4Api,"show-checkbox":"","node-key":"value",class:"permission-tree"},null,8,["check-strictly","data","props"])])),_:1})):V("",!0)])),_:1},8,["model"])])),_:1},8,["size","modelValue","title"])])}}}),[["__scopeId","data-v-978c72f3"]]);export{G as default};
