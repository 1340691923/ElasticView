import{b7 as e,d as l,aQ as t,c as a,aV as o,r as i,a0 as r,cc as s,J as d,o as n,cd as c,aJ as p,e as u,h as f,C as h,l as m,w as g,g as y,a7 as b,F as k,a3 as _,f as v,j as w,bJ as x,bK as C,p as V,a2 as j,aY as A,b5 as $,a5 as T,a6 as S,ba as N}from"./index.CeDXPVSD.js";/* empty css                   */import{E as O}from"./el-drawer.ZfVaGiZ0.js";import{E}from"./el-tree.BIhb9rHm.js";import"./el-checkbox.D4z8pLqr.js";import{E as U}from"./el-pagination.BD64g3b9.js";/* empty css               */import"./el-select.CuqbsI_Z.js";import"./el-scrollbar.C0SjPjve.js";import"./el-tooltip.DeOoh3S_.js";import{E as R}from"./el-card.Cx8qXsER.js";import{E as z,a as J}from"./el-table-column.u_VJJ4LY.js";import{a as L,E as M}from"./el-form.CyAu9Gll.js";import"./el-form-item.l0sNRNKZ.js";import{d as B}from"./index.B6fdKp2E.js";import{U as P}from"./api-rbac.CLVIIGbi.js";import{_ as D}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./use-dialog.DWl0CYH9.js";import"./isUndefined.DgmxjSXK.js";import"./index.CWr3KaP0.js";import"./strings.DM4HtHVe.js";import"./index.H2r2dG6H.js";import"./_Uint8Array.4jrYBpH3.js";const I={class:"app-container"},F={class:"search-container"},K={class:"pagination-container"},q=D(l({__name:"role",setup(l){const D=t(),q=a((()=>D.device===o.MOBILE)),G=i(0),H=e=>{ue.limit=e,fe(1)},Q={id:"",name:"",description:"",routes:[],api:[]},Y=r({role_name:""}),W=r({asyncRoutes:s,allAsyncRoutes:[],editLinkRoleId:0,loading:!1,allApiConfig:[],value:[],filterMethod:(e,l)=>l.label.indexOf(e)>-1,urlConfig:[],urlConfigMap:[],filterText:"",filterText4Api:"",role:Object.assign({},Q),routes:[],rolesList:[],dialogVisible:!1,esLinkDialogVisible:!1,dialogType:"new",checkStrictly:!1,defaultProps:{children:"children",label:"title"},defaultProps4Api:{children:"options",label:"label"},chanCfgList:[],apiCfg:[],selectAllApiCfg:[],apiMap:{},data:[]}),X=i(),Z=i();d(W.filterText,(e=>{X.value.filter(e)})),d(W.filterText4Api,(e=>{Z.value.filter(e)})),n((async()=>{await ee(),ae(),fe(1)}));const ee=async()=>{let e=await P({need_auth:!0});if(0==e.code){let l=JSON.parse(JSON.stringify(e.data.cfg_with_module)),t=l.length;for(;t--;){let e=l[t],a=e.options.length,o=e.options;for(;a--;)o[a].needAuth||o.splice(a,1),0==o.length&&l.splice(t,1)}W.apiMap={},W.selectAllApiCfg=[];for(let e of l)for(let l of e.options)W.selectAllApiCfg.push(l),W.apiMap[l.value]=l;W.apiCfg=l}},le=()=>{X.value.setCheckedNodes(W.routes)},te=()=>{Z.value.setCheckedNodes(W.selectAllApiCfg)},ae=async()=>{let e=await c({routers:s});W.allAsyncRoutes=e.data;var l=e.data;W.routes=ie(l)},oe=(e=[],l)=>{let t=null;const a=e.filter((e=>!e.hidden));return 1===a.length?(t=a[0],t.path=p.resolve(l.path,t.path),t):0===a.length&&(t={...l,path:"",noShowingChildren:!0},t)},ie=(e,l="/")=>{const t=[];for(let a of e){if(a.hidden&&!a.service)continue;const e=oe(a.children,a);a.children&&a.children.length>0&&e&&!a.alwaysShow&&(a=e);const o={path:p.resolve(l,a.path),title:a.meta&&a.meta.title};a.children&&a.children.length>0&&(o.children=ie(a.children,o.path)),t.push(o)}return t},re=e=>{let l=[];return e.forEach((e=>{if(l.push(e),e.children&&e.children.length>0){const t=re(e.children);t.length>0&&(l=[...l,...t])}})),l},se=(e,l="/",t)=>{const a=[];for(const o of e)o.children&&o.children.length>0&&(o.children=se(o.children,p.resolve(l,o.path),t)),(t.includes(p.resolve(l,o.path))||o.children&&o.children.length>=1)&&a.push(o);return a},de=(e,l)=>!e||-1!==l.title.indexOf(e),ne=(e,l)=>!e||-1!==l.label.indexOf(e),ce=()=>{W.role=Object.assign({},Q),X.value&&X.value.setCheckedNodes([]),Z.value&&Z.value.setCheckedNodes([]),W.dialogType="new",W.dialogVisible=!0},pe=e=>{W.dialogType="edit",W.dialogVisible=!0,W.checkStrictly=!0,W.role=B(e),j((()=>{const e=ie(W.role.routes);X.value.setCheckedNodes(re(e));let l=[];for(let t of W.role.api)l.push(W.apiMap[t]);Z.value&&Z.value.setCheckedNodes(l),W.checkStrictly=!1}))},ue=r({page:1,limit:10}),fe=async l=>{ue.page=l||1,W.loading=!0;const t=await(a={role_name:Y.role_name,page:l,page_size:ue.limit},e({url:"/api/gm_user/roles",method:"post",data:a}));var a;for(var o in W.loading=!1,t.data.list)t.data.list[o].routes=JSON.parse(t.data.list[o].routes);G.value=t.data.count,W.rolesList=t.data.list},he=({$index:l,row:t})=>{A.confirm("确定删除这个角色吗?","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((async()=>{let l=await(a={id:t.id},e({url:"/api/gm_user/role/delete",method:"post",data:a}));var a;0==l.code?(await fe(1),0==l.code?$.success({type:"success",offset:60,message:l.msg}):$.error({type:"error",offset:60,message:l.msg})):$.error({type:"error",offset:60,message:l.msg})})).catch((e=>{console.error(e)}))},me=async()=>{if(Z.value){const e=Z.value.getCheckedNodes(!0,!1);let l=[];for(let t of e)l.push(t.value);W.role.api=l}const l="edit"===W.dialogType,t=X.value.getCheckedKeys();W.role.routes=se(B(W.allAsyncRoutes),"/",t);var a,o=W.role;if(o.routes=JSON.stringify(o.routes),l){o.id=W.role.id;let l=await(a=o,e({url:"/api/gm_user/role/update",method:"post",data:a}));if(0!=l.code)return void $.error({type:"error",offset:60,message:l.msg});fe(1)}else{o.id=0;const l=await function(l){return e({url:"/api/gm_user/role/add",method:"post",data:l})}(o);if(0!=l.code)return void $.error({type:"error",offset:60,message:l.msg});fe(1)}W.dialogVisible=!1,$.success({type:"success",offset:60,message:"操作成功"})};return(e,l)=>{const t=T,a=S,o=L,i=M,r=z,s=J,d=R,n=U,c=E,p=O,j=N;return u(),f("div",I,[h("div",F,[m(i,{inline:!0},{default:g((()=>[m(o,{label:"角色名:",prop:"keywords"},{default:g((()=>[m(t,{clearable:"",modelValue:y(Y).role_name,"onUpdate:modelValue":l[0]||(l[0]=e=>y(Y).role_name=e),style:{width:"160px"}},null,8,["modelValue"]),m(a,{style:{"margin-left":"10px"},type:"success",class:"filter-item",onClick:l[1]||(l[1]=e=>fe(1))},{default:g((()=>[b(k(e.$t("搜索")),1)])),_:1})])),_:1}),m(o,{label:"",prop:"keywords"},{default:g((()=>[m(a,{type:"warning",class:"filter-item",onClick:ce},{default:g((()=>[b(k(e.$t("新增")),1)])),_:1})])),_:1})])),_:1})]),m(d,{shadow:"never",class:"table-container"},{default:g((()=>[_((u(),v(s,{data:y(W).rolesList,onRowDblclick:pe},{default:g((()=>[m(r,{align:"center",label:e.$t("id"),width:"40"},{default:g((e=>[b(k(e.row.id),1)])),_:1},8,["label"]),m(r,{align:"center",label:e.$t("角色名"),width:"200"},{default:g((e=>[b(k(e.row.name),1)])),_:1},8,["label"]),m(r,{align:"header-center",label:e.$t("角色详细信息")},{default:g((e=>[b(k(e.row.description),1)])),_:1},8,["label"]),m(r,{align:"center",label:e.$t("操作"),width:"140",fixed:"right"},{default:g((e=>[m(a,{type:"primary",onClick:w((l=>pe(e.row)),["stop"]),icon:y(x)},null,8,["onClick","icon"]),m(a,{type:"danger",onClick:w((l=>he(e)),["stop"]),icon:y(C)},null,8,["onClick","icon"])])),_:1},8,["label"])])),_:1},8,["data"])),[[j,y(W).loading]])])),_:1}),h("div",K,[m(n,{background:"","current-page":y(ue).page,"page-size":y(ue).limit,total:y(G),onCurrentChange:fe,onSizeChange:H},null,8,["current-page","page-size","total"])]),m(p,{size:y(q)?"100%":"70%",modelValue:y(W).dialogVisible,"onUpdate:modelValue":l[7]||(l[7]=e=>y(W).dialogVisible=e),title:"edit"===y(W).dialogType?e.$t("修改角色"):e.$t("新建角色")},{footer:g((()=>[m(a,{type:"danger",onClick:l[6]||(l[6]=e=>y(W).dialogVisible=!1)},{default:g((()=>[b(k(e.$t("取消")),1)])),_:1}),m(a,{type:"primary",onClick:me},{default:g((()=>[b(k(e.$t("确定")),1)])),_:1})])),default:g((()=>[m(i,{model:y(W).role,"label-width":"80px","label-position":"left"},{default:g((()=>[m(o,{label:e.$t("角色名")},{default:g((()=>[m(t,{modelValue:y(W).role.name,"onUpdate:modelValue":l[2]||(l[2]=e=>y(W).role.name=e),placeholder:e.$t("角色名")},null,8,["modelValue","placeholder"])])),_:1},8,["label"]),m(o,{label:e.$t("角色详情信")},{default:g((()=>[m(t,{modelValue:y(W).role.description,"onUpdate:modelValue":l[3]||(l[3]=e=>y(W).role.description=e),autosize:{minRows:2,maxRows:4},type:"textarea",placeholder:e.$t("角色详情信息")},null,8,["modelValue","placeholder"])])),_:1},8,["label"]),1!=y(W).role.id?(u(),v(o,{key:0,label:e.$t("菜单栏")},{default:g((()=>[m(t,{modelValue:y(W).filterText,"onUpdate:modelValue":l[4]||(l[4]=e=>y(W).filterText=e),placeholder:e.$t("输入关键字进行过滤"),style:{width:"300px"}},null,8,["modelValue","placeholder"]),m(a,{onClick:le},{default:g((()=>[b(k(e.$t("全选")),1)])),_:1})])),_:1},8,["label"])):V("",!0),1!=y(W).role.id?(u(),v(o,{key:1},{default:g((()=>[m(c,{"default-expand-all":"","check-on-click-node":"",ref_key:"menu_tree",ref:X,"filter-node-method":de,"check-strictly":y(W).checkStrictly,data:y(W).routes,props:y(W).defaultProps,"show-checkbox":"","node-key":"path",class:"permission-tree"},null,8,["check-strictly","data","props"])])),_:1})):V("",!0),1!=y(W).role.id?(u(),v(o,{key:2,label:e.$t("接口权限")},{default:g((()=>[m(t,{modelValue:y(W).filterText4Api,"onUpdate:modelValue":l[5]||(l[5]=e=>y(W).filterText4Api=e),placeholder:e.$t("输入关键字进行过滤"),style:{width:"300px"}},null,8,["modelValue","placeholder"]),m(a,{onClick:te},{default:g((()=>[b(k(e.$t("全选")),1)])),_:1})])),_:1},8,["label"])):V("",!0),1!=y(W).role.id?(u(),v(o,{key:3},{default:g((()=>[m(c,{"default-expand-all":"","check-on-click-node":"",ref_key:"api_tree",ref:Z,"filter-node-method":ne,"check-strictly":y(W).checkStrictly,data:y(W).apiCfg,props:y(W).defaultProps4Api,"show-checkbox":"","node-key":"value",class:"permission-tree"},null,8,["check-strictly","data","props"])])),_:1})):V("",!0)])),_:1},8,["model"])])),_:1},8,["size","modelValue","title"])])}}}),[["__scopeId","data-v-ea002fa5"]]);export{q as default};
