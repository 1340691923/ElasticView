import{d as e,a0 as l,dN as t,r as a,J as o,o as i,dO as r,aA as s,e as d,h as n,C as c,l as p,w as u,a7 as f,F as h,a3 as m,f as g,g as y,j as b,p as k,a2 as _,aP as w,aY as v,a6 as C,a5 as x,bc as j}from"./index.DMBpWXpT.js";/* empty css                   */import{E as $}from"./el-drawer.CpqknkfB.js";import{E as V}from"./el-tree.UTBgh5GW.js";import"./el-checkbox.8MJHthul.js";import{E as A}from"./el-card.BhvZLWwX.js";import{E as T,a as N}from"./el-table-column.Dl1jn1Bd.js";import"./el-tooltip.l0sNRNKZ.js";import"./el-popper.Cb3Eus9m.js";import"./el-scrollbar.BJ_tYB1D.js";/* empty css               */import{a as S,E as O}from"./el-form.DUR-mZNt.js";import"./el-form-item.l0sNRNKZ.js";import{d as U}from"./index.B6fdKp2E.js";import{g as R,d as E,u as L,a as M}from"./role.BVYrj-EL.js";import{U as P}from"./api-rbac.BkPPKqLP.js";import{_ as J}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./use-dialog.CoOh9qjD.js";import"./isUndefined.DgmxjSXK.js";import"./token.DWNpOE8r.js";import"./isEqual.B61-3bNT.js";import"./_Uint8Array.BEOPqGcx.js";import"./index.CP01f_MK.js";import"./debounce.l44evi-0.js";import"./castArray.arHVDzqw.js";const z={class:"app-container"},B={class:"search-container"},D=J(e({__name:"role",setup(e){const J={id:"",name:"",description:"",routes:[],api:[]},D=l({asyncRoutes:t,allAsyncRoutes:[],editLinkRoleId:0,loading:!1,allApiConfig:[],value:[],filterMethod:(e,l)=>l.label.indexOf(e)>-1,urlConfig:[],urlConfigMap:[],filterText:"",filterText4Api:"",role:Object.assign({},J),routes:[],rolesList:[],dialogVisible:!1,esLinkDialogVisible:!1,dialogType:"new",checkStrictly:!1,defaultProps:{children:"children",label:"title"},defaultProps4Api:{children:"options",label:"label"},chanCfgList:[],apiCfg:[],selectAllApiCfg:[],apiMap:{},data:[]}),I=a(),K=a();o(D.filterText,(e=>{I.value.filter(e)})),o(D.filterText4Api,(e=>{K.value.filter(e)})),i((async()=>{await q(),Q(),ae()}));const q=async()=>{let e=await P({need_auth:!0});if(0==e.code){let l=JSON.parse(JSON.stringify(e.data.cfg_with_module)),t=l.length;for(;t--;){let e=l[t],a=e.options.length,o=e.options;for(;a--;)o[a].needAuth||o.splice(a,1),0==o.length&&l.splice(t,1)}D.apiMap={},D.selectAllApiCfg=[];for(let e of l)for(let l of e.options)D.selectAllApiCfg.push(l),D.apiMap[l.value]=l;D.apiCfg=l}},F=()=>{I.value.setCheckedNodes(D.routes)},H=()=>{K.value.setCheckedNodes(D.selectAllApiCfg)},Q=async()=>{let e=await r({routers:t});D.allAsyncRoutes=e.data;var l=e.data;D.routes=X(l)},W=(e=[],l)=>{let t=null;const a=e.filter((e=>!e.hidden));return 1===a.length?(t=a[0],t.path=s.resolve(l.path,t.path),t):0===a.length&&(t={...l,path:"",noShowingChildren:!0},t)},X=(e,l="/")=>{const t=[];for(let a of e){if(a.hidden&&!a.service)continue;const e=W(a.children,a);a.children&&a.children.length>0&&e&&!a.alwaysShow&&(a=e);const o={path:s.resolve(l,a.path),title:a.meta&&a.meta.title};a.children&&a.children.length>0&&(o.children=X(a.children,o.path)),t.push(o)}return t},Y=e=>{let l=[];return e.forEach((e=>{if(l.push(e),e.children&&e.children.length>0){const t=Y(e.children);t.length>0&&(l=[...l,...t])}})),l},Z=(e,l="/",t)=>{const a=[];for(const o of e)o.children&&o.children.length>0&&(o.children=Z(o.children,s.resolve(l,o.path),t)),(t.includes(s.resolve(l,o.path))||o.children&&o.children.length>=1)&&a.push(o);return a},G=(e,l)=>!e||-1!==l.title.indexOf(e),ee=(e,l)=>!e||-1!==l.label.indexOf(e),le=()=>{D.role=Object.assign({},J),I.value&&I.value.setCheckedNodes([]),K.value&&K.value.setCheckedNodes([]),D.dialogType="new",D.dialogVisible=!0},te=e=>{D.dialogType="edit",D.dialogVisible=!0,D.checkStrictly=!0,D.role=U(e),_((()=>{const e=X(D.role.routes);I.value.setCheckedNodes(Y(e));let l=[];for(let t of D.role.api)l.push(D.apiMap[t]);K.value&&K.value.setCheckedNodes(l),D.checkStrictly=!1}))},ae=async()=>{D.loading=!0;const e=await R();for(var l in D.loading=!1,e.data)e.data[l].routes=JSON.parse(e.data[l].routes);D.rolesList=e.data},oe=async()=>{if(K.value){const e=K.value.getCheckedNodes(!0,!1);let l=[];for(let t of e)l.push(t.value);D.role.api=l}const e="edit"===D.dialogType,l=I.value.getCheckedKeys();D.role.routes=Z(U(D.allAsyncRoutes),"/",l);var t=D.role;if(t.routes=JSON.stringify(t.routes),e){t.id=D.role.id;let e=await L(t);if(0!=e.code)return void v.error({type:"error",message:e.msg});ae()}else{t.id=0;const e=await M(t);if(0!=e.code)return void v.error({type:"error",message:e.msg});ae()}D.dialogVisible=!1,v.success({type:"success",message:"操作成功"})};return(e,l)=>{const t=C,a=S,o=O,i=T,r=N,s=A,_=x,U=V,R=$,L=j;return d(),n("div",z,[c("div",B,[p(o,{inline:!0},{default:u((()=>[p(a,{label:"",prop:"keywords"},{default:u((()=>[p(t,{type:"warning",class:"filter-item",onClick:le},{default:u((()=>[f(h(e.$t("新建角色")),1)])),_:1})])),_:1}),p(a,{label:""},{default:u((()=>[p(t,{type:"success",class:"filter-item",onClick:ae},{default:u((()=>[f(h(e.$t("查询")),1)])),_:1})])),_:1})])),_:1})]),p(s,{shadow:"never",class:"table-container"},{default:u((()=>[m((d(),g(r,{data:y(D).rolesList,onRowDblclick:te},{default:u((()=>[p(i,{align:"center",label:e.$t("角色id"),width:"220"},{default:u((e=>[f(h(e.row.id),1)])),_:1},8,["label"]),p(i,{align:"center",label:e.$t("角色名"),width:"220"},{default:u((e=>[f(h(e.row.name),1)])),_:1},8,["label"]),p(i,{align:"header-center",label:e.$t("角色详细信息")},{default:u((e=>[f(h(e.row.description),1)])),_:1},8,["label"]),p(i,{align:"center",label:e.$t("操作"),width:"200",fixed:"right"},{default:u((l=>[p(t,{type:"primary",onClick:b((e=>te(l.row)),["stop"])},{default:u((()=>[f(h(e.$t("编辑")),1)])),_:2},1032,["onClick"]),p(t,{type:"danger",onClick:b((e=>(({$index:e,row:l})=>{w.confirm("确定删除这个角色吗?","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((async()=>{let e=await E({id:l.id});0==e.code?(await ae(),0==e.code?v.success({type:"success",message:e.msg}):v.error({type:"error",message:e.msg})):v.error({type:"error",message:e.msg})})).catch((e=>{console.error(e)}))})(l)),["stop"])},{default:u((()=>[f(h(e.$t("删除")),1)])),_:2},1032,["onClick"])])),_:1},8,["label"])])),_:1},8,["data"])),[[L,y(D).loading]])])),_:1}),p(R,{size:"60%",modelValue:y(D).dialogVisible,"onUpdate:modelValue":l[5]||(l[5]=e=>y(D).dialogVisible=e),title:"edit"===y(D).dialogType?e.$t("修改角色"):e.$t("新建角色")},{footer:u((()=>[p(t,{type:"danger",onClick:l[4]||(l[4]=e=>y(D).dialogVisible=!1)},{default:u((()=>[f(h(e.$t("取消")),1)])),_:1}),p(t,{type:"primary",onClick:oe},{default:u((()=>[f(h(e.$t("确定")),1)])),_:1})])),default:u((()=>[p(o,{model:y(D).role,"label-width":"120px","label-position":"left"},{default:u((()=>[p(a,{label:e.$t("角色名")},{default:u((()=>[p(_,{modelValue:y(D).role.name,"onUpdate:modelValue":l[0]||(l[0]=e=>y(D).role.name=e),placeholder:e.$t("角色名")},null,8,["modelValue","placeholder"])])),_:1},8,["label"]),p(a,{label:e.$t("角色详情信息")},{default:u((()=>[p(_,{modelValue:y(D).role.description,"onUpdate:modelValue":l[1]||(l[1]=e=>y(D).role.description=e),autosize:{minRows:2,maxRows:4},type:"textarea",placeholder:e.$t("角色详情信息")},null,8,["modelValue","placeholder"])])),_:1},8,["label"]),p(a,{label:e.$t("菜单栏")},{default:u((()=>[p(_,{modelValue:y(D).filterText,"onUpdate:modelValue":l[2]||(l[2]=e=>y(D).filterText=e),placeholder:e.$t("输入关键字进行过滤"),style:{width:"300px"}},null,8,["modelValue","placeholder"]),p(t,{onClick:F},{default:u((()=>[f(h(e.$t("全选")),1)])),_:1})])),_:1},8,["label"]),p(a,null,{default:u((()=>[p(U,{"default-expand-all":"","check-on-click-node":"",ref_key:"menu_tree",ref:I,"filter-node-method":G,"check-strictly":y(D).checkStrictly,data:y(D).routes,props:y(D).defaultProps,"show-checkbox":"","node-key":"path",class:"permission-tree"},null,8,["check-strictly","data","props"])])),_:1}),1!=y(D).role.id?(d(),g(a,{key:0,label:e.$t("接口权限设置")},{default:u((()=>[p(_,{modelValue:y(D).filterText4Api,"onUpdate:modelValue":l[3]||(l[3]=e=>y(D).filterText4Api=e),placeholder:e.$t("输入关键字进行过滤"),style:{width:"300px"}},null,8,["modelValue","placeholder"]),p(t,{onClick:H},{default:u((()=>[f(h(e.$t("全选")),1)])),_:1})])),_:1},8,["label"])):k("",!0),1!=y(D).role.id?(d(),g(a,{key:1},{default:u((()=>[p(U,{"default-expand-all":"","check-on-click-node":"",ref_key:"api_tree",ref:K,"filter-node-method":ee,"check-strictly":y(D).checkStrictly,data:y(D).apiCfg,props:y(D).defaultProps4Api,"show-checkbox":"","node-key":"value",class:"permission-tree"},null,8,["check-strictly","data","props"])])),_:1})):k("",!0)])),_:1},8,["model"])])),_:1},8,["modelValue","title"])])}}}),[["__scopeId","data-v-1ba34e83"]]);export{D as default};
